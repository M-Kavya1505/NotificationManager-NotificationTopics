<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropdown Example</title>

</head>
<body>
    <h1>Select an Option</h1>
    <form onsubmit="handleSubmit(event)">
        <label for="options">Choose an option:</label>
        <select id="options" name="options" onchange="handleDropdownChange()">
            <option value="all">All</option>
            <option value="userid">userid</option>
            <option value="bluboyid">bluboyid</option>
        </select>

        <br><br>

        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required>

        <br><br>

        <label for="message">Message:</label>
        <input type="text" id="message" name="message" required>

        <br><br>

        <div id="extra-input-container" style="display: none;">
            <label for="extra-input">Enter IDs (comma separated):</label>
            <textarea id="extra-input" name="extra-input"></textarea>

            <br><br>
        </div>
        
        <button type="submit" id = "submit-btn">Submit</button>
    </form>
    <!-- DISPLAY INFO -->
    <div id="tracker-info"></div>
    <div id="server-info"></div>
    <div id = "operation-status"></div>
    <!--script src="{{ url_for('static', filename='scripts.js') }}"></script-->
    <script>
        const options_list = document.getElementById('options');
        const trackerInfo = document.getElementById("tracker-info");
        const operationStatus = document.getElementById("operation-status");
        const submitBtn = document.getElementById("submit-btn");
        const baseUrl = window.location.origin;
        var IntervalId ;
        var num_users_with_tokens;
        async function handleSubmit(event) {
            event.preventDefault();
            const options = options_list.value;
            const title = document.getElementById('title').value;
            const message = document.getElementById('message').value;
            const extraInput = document.getElementById('extra-input').value;
            
            let url;
            let data = {
                title: title,
                message: message
            };
    
            if (options === 'all') {
                url = `${baseUrl}/test/start`;
            } else if (options === 'bluboyid') {
                url = `${baseUrl}/pushbluboy`;
                data.bluboyid = extraInput.split(',').map(item => item.trim());
                trackerInfo.innerHTML = `<div>
                        <p>Number of BluBoy Ids To Check: ${data.bluboyid.length}</p>
                    </div>`
            } else if (options === 'userid') {
                url = `${baseUrl}/pushuserid`;
                data.userid = extraInput.split(',').map(item => item.trim());
                trackerInfo.innerHTML = `<div>
                        <p>Number of User Ids To Check: ${data.userid.length}</p>
                    </div>`
            }
            await fetch(`${baseUrl}/test/tracker`)
            .then(response => response.json())
            .then(data=>{
                if (options_list.value === "all" ) {
                    trackerInfo.innerHTML=`
                    <div>
                        <p>Number of Users : ${data["num_users"]} </p>
                        <p>Number of Users with Tokens in DB: ${data["num_users_with_tokens"]}</p>
                        <p>Number of Logged Out Users: ${data["num_logged_out"]}</p>    
                    </div>
                    `    
                }
                
                num_users_with_tokens = data["num_users_with_tokens"]
            })
    
            await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                submitBtn.disable = true
                IntervalId = setInterval(checkStatus,2000)
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    
        function handleDropdownChange() {
            const options = document.getElementById('options').value;
            const extraInputContainer = document.getElementById('extra-input-container');
    
            if (options === 'all') {
                extraInputContainer.style.display = 'none';
            } else {
                extraInputContainer.style.display = 'block';
            }
        }
        
        function checkStatus(){
            serverInfo = document.getElementById("server-info")
            fetch(`${baseUrl}/test/fetch_completed_users`)
            .then(async (response) => {
                if (!response.ok) {
                    clearInterval(IntervalId)
                    submitBtn.disable = false
                    throw new Error('Network response was not ok ' + response.statusText);
                
                } else {
                    responseJSON = await response.json()
                    obj = responseJSON["completed"].split("\n")
                    if (obj[1] >= num_users_with_tokens) {
                        clearInterval(IntervalId)
                        console.log("INTERVAL OVER")
                    }
                    if (options_list.value === "all") {
                        serverInfo.innerHTML = `
                        <div>
                        <p>NUMBER OF TOKENS CHECKED : ${obj[1]}/${num_users_with_tokens}</p>
                        <p>NUMBER OF SUCCESS : ${obj[2]}</p>
                        <p>NUMBER OF FAILURES : ${obj[3]}</p>
                        </div>
                        `    
                    } else if (options_list.value === "bluboyid" || options_list.value === "userid") {
                        serverInfo.innerHTML = `
                        <div>
                        <p>NUMBER OF USERS WITH TOKENS: ${obj[1]}</p>
                        <p>NUMBER OF SUCCESS : ${obj[2]}</p>
                        <p>NUMBER OF FAILURES : ${obj[3]}</p>
                        </div>
                        `
                    } 
                    if (obj[0] === "done") {
                        console.log("DONE")
                        submitBtn.disable = false
                        clearInterval(IntervalId)
                        operationStatus.innerHTML = `<h3>DONE</h3>`
                    } else {
                        console.log("ONGOING")
                        operationStatus.innerHTML = `<h3>ONGOING</h3>`
                    }
                    
                }
            })
        }
            
    </script>
</body>
</html>
